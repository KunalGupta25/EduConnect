<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        // Enable class-based dark mode in Tailwind CDN
        try { tailwind.config = { darkMode: 'class' }; } catch (_) {}
    </script>
    <script>
        // Global theme helpers
        window.__setInitialTheme = function() {
            try {
                const stored = localStorage.getItem('theme');
                const preferDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (stored === 'dark' || (!stored && preferDark)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            } catch (_) {}
        };
        __setInitialTheme();
        window.toggleTheme = function() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };
    </script>
    <style>
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .bento-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        .bento-item {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1rem;
        }

        .bento-item-1 {
            grid-column: span 1;
        }

        .bento-item-2 {
            grid-column: span 1;
        }

        .bento-item-3 {
            grid-column: span 1;
        }

        .bento-item-4 {
            grid-column: span 1;
        }

        .bento-item-5 {
            grid-column: span 1;
        }

        .bento-item-6 {
            grid-column: span 1;
        }

        @media (min-width: 768px) {
            .bento-item-1 {
                grid-column: span 4;
            }

            .bento-item-2 {
                grid-column: span 2;
            }

            .bento-item-3 {
                grid-column: span 2;
            }

            .bento-item-4 {
                grid-column: span 4;
            }

            .bento-item-5 {
                grid-column: span 4;
            }

            .bento-item-6 {
                grid-column: span 4;
            }
        }

        @media (min-width: 1024px) {
            .bento-item-1 {
                grid-column: span 6;
            }

            .bento-item-2 {
                grid-column: span 2;
            }

            .bento-item-3 {
                grid-column: span 2;
            }

            .bento-item-4 {
                grid-column: span 2;
            }

            .bento-item-5 {
                grid-column: span 4;
            }

            .bento-item-6 {
                grid-column: span 2;
            }
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-list::-webkit-scrollbar {
            width: 6px;
        }

        .student-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .student-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 dark:text-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-orange-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i data-feather="user-check" class="w-6 h-6"></i>
                    <h1 class="text-xl font-bold">Attendance Dashboard</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" onclick="toggleTheme()" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/20">
                        <i data-feather="moon" class="w-4 h-4"></i><span class="hidden sm:inline">Theme</span>
                    </button>
                    <span class="text-sm">{{ teacher_name }}</span>
                    <div class="w-8 h-8 rounded-full bg-orange-400 flex items-center justify-center">
                        <i data-feather="user" class="w-4 h-4"></i>
                    </div>
                    <a href="{{ url_for('logout') }}" class="text-sm hover:text-orange-100">Logout</a>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-4">
            <div class="bento-grid">
                <!-- Lecture Info + Summary -->
                <div class="bento-item bento-item-1">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">CS-101: Introduction to Programming</h2>
                            <p class="text-gray-600 text-sm">Monday, 10:00 AM - 11:30 AM | Room: B-204</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                            Active Lecture
                        </span>
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        <div class="bg-orange-50 p-2 rounded-lg text-center">
                            <div id="summaryTotal" class="text-orange-800 font-bold text-lg">0</div>
                            <div class="text-orange-600 text-xs">Total</div>
                        </div>
                        <div class="bg-green-50 p-2 rounded-lg text-center">
                            <div id="summaryPresent" class="text-green-800 font-bold text-lg">0</div>
                            <div class="text-green-600 text-xs">Present</div>
                        </div>
                        <div class="bg-red-50 p-2 rounded-lg text-center">
                            <div id="summaryAbsent" class="text-red-800 font-bold text-lg">0</div>
                            <div class="text-red-600 text-xs">Absent</div>
                        </div>
                        <div class="bg-purple-50 p-2 rounded-lg text-center">
                            <div id="summaryRate" class="text-purple-800 font-bold text-lg">%</div>
                            <div class="text-purple-600 text-xs">Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bento-item bento-item-2">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i data-feather="zap" class="w-4 h-4 mr-1"></i> Quick Actions
                    </h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="markAllPresent"
                            class="bg-green-100 hover:bg-green-200 text-green-800 py-2 rounded-md flex flex-col items-center text-sm">
                            <i data-feather="check-circle" class="w-5 h-5 mb-1"></i> All Present
                        </button>
                        <button id="markAllAbsent"
                            class="bg-red-100 hover:bg-red-200 text-red-800 py-2 rounded-md flex flex-col items-center text-sm">
                            <i data-feather="x-circle" class="w-5 h-5 mb-1"></i> All Absent
                        </button>
                        <button id="setTeacherLocation"
                            class="bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 rounded-md flex flex-col items-center text-sm">
                            <i data-feather="map-pin" class="w-5 h-5 mb-1"></i> Set Location
                        </button>
                    </div>
                </div>

                <!-- Manual Attendance -->
                <div class="bento-item bento-item-3">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i data-feather="edit" class="w-4 h-4 mr-1"></i> Manual Attendance
                    </h3>
                    <div class="flex space-x-2">
                        <input type="text" id="enrollmentInput" placeholder="Enrollment No."
                            class="flex-1 px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <button id="markManual"
                            class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded-md">
                            <i data-feather="check" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Alerts -->
                <div class="bento-item bento-item-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i data-feather="alert-triangle" class="w-4 h-4 mr-1"></i> Alerts
                    </h3>
                    <div id="alertsList" class="space-y-2 text-sm">
                        <!-- Alerts will load here -->
                    </div>
                </div>

                <!-- Student List -->
                <div class="bento-item bento-item-5">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                            <i data-feather="list" class="w-4 h-4 mr-1"></i>
                            <span id="listTitle">Present Students</span>
                        </h3>
                        <div class="flex items-center space-x-2">
                            <button id="toggleStudents"
                                class="bg-orange-600 text-white px-2 py-1 text-xs rounded-md">Toggle</button>
                            <button id="refreshStudents"
                                class="text-gray-500 hover:text-orange-600 transition-colors">
                                <i data-feather="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="student-list">
                        <div id="studentList" class="space-y-1 text-sm">
                            <!-- Student entries will load here -->
                        </div>
                    </div>
                </div>

                <!-- Manual Attendance Requests -->
                <div class="bento-item bento-item-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <i data-feather="user-plus" class="w-4 h-4 mr-1"></i> Manual Attendance Requests
                    </h3>
                    <div id="manualRequestsList" class="space-y-2 text-sm">
                        <!-- Manual attendance requests will load here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Manual Attendance Request Modal -->
    <div id="manualAttendanceModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-lg font-semibold mb-4">Manual Attendance Request</h2>
            <div id="modalStudentDetails"></div>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="modalIgnoreBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">Ignore</button>
                <button id="modalApproveBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">Mark Present</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const listTitle = document.getElementById("listTitle");
            const studentList = document.getElementById("studentList");
            const toggleBtn = document.getElementById("toggleStudents");
            const refreshBtn = document.getElementById("refreshStudents");
            const enrollmentInput = document.getElementById("enrollmentInput");
            const markManualBtn = document.getElementById("markManual");
            const markAllPresentBtn = document.getElementById("markAllPresent");
            const markAllAbsentBtn = document.getElementById("markAllAbsent");
            const setTeacherLocationBtn = document.getElementById("setTeacherLocation");
            const alertsList = document.getElementById("alertsList");
            const manualRequestsList = document.getElementById("manualRequestsList");
            const teacherId = {{ teacher_id | tojson }};
            const socket = io();
            // Join personal room identified by teacherId for alerts
            socket.on('connect', () => {
                // No explicit join needed if server joins on each request; keep for future
                console.log('Socket connected');
            });
            socket.on('attendance_alert', (payload) => {
                // Render an alert item into Alerts panel
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 rounded-md bg-yellow-50';
                div.innerHTML = `<i data-feather="alert-triangle" class="w-4 h-4 mr-2 text-yellow-600"></i>
                                 <p class="text-xs text-gray-700">${payload.message}</p>`;
                alertsList.prepend(div);
                feather.replace();
            });
            const manualAttendanceModal = document.getElementById("manualAttendanceModal");
            const modalStudentDetails = document.getElementById("modalStudentDetails");
            const modalApproveBtn = document.getElementById("modalApproveBtn");
            const modalIgnoreBtn = document.getElementById("modalIgnoreBtn");
            const closeModal = document.getElementsByClassName("close")[0];

            let currentStatus = 'Present';

            async function fetchStudents() {
                try {
                    const response = await fetch(`/api/get-present-students?status=${currentStatus}`);
                    const students = await response.json();
                    studentList.innerHTML = "";
                    if (students.length === 0) {
                        studentList.innerHTML = `<p class="text-gray-500 text-sm">No students ${currentStatus.toLowerCase()} today.</p>`;
                        return;
                    }
                    students.forEach(s => {
                        const studentElement = `
                            <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-md">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 rounded-full ${currentStatus === 'Present' ? 'bg-green-100' : 'bg-red-100'} flex items-center justify-center">
                                        <i data-feather="user" class="w-4 h-4 ${currentStatus === 'Present' ? 'text-green-600' : 'text-red-600'}"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">${s.name}</p>
                                        <p class="text-xs text-gray-500">${s.enrollment_no}</p>
                                    </div>
                                </div>
                                <span class="attendance-badge px-2 py-1 rounded-full text-xs font-medium ${currentStatus === 'Present' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${currentStatus}
                                </span>
                            </div>`;
                        studentList.innerHTML += studentElement;
                    });
                    feather.replace();
                } catch (err) {
                    console.error("Error fetching students:", err);
                    studentList.innerHTML = `<p class="text-gray-500 text-sm">Error loading students.</p>`;
                }
            }

            async function fetchSummary() {
                try {
                    const response = await fetch('/api/summary');
                    const data = await response.json();
                    document.getElementById('summaryTotal').textContent = data.total;
                    document.getElementById('summaryPresent').textContent = data.present;
                    document.getElementById('summaryAbsent').textContent = data.absent;
                    document.getElementById('summaryRate').textContent = data.rate + '%';
                } catch (err) {
                    console.error('Error loading summary:', err);
                }
            }

            async function fetchAlerts() {
                try {
                    const response = await fetch('/api/alerts');
                    const alerts = await response.json();
                    alertsList.innerHTML = "";
                    if (alerts.length === 0) {
                        alertsList.innerHTML = `<p class="text-gray-500 text-sm">No alerts.</p>`;
                        return;
                    }
                    alerts.forEach(alert => {
                        const alertElement = `
                            <div class="flex items-center p-2 rounded-md ${alert.type === 'info' ? 'bg-blue-50' : 'bg-yellow-50'}">
                                <i data-feather="${alert.type === 'info' ? 'info' : 'alert-triangle'}" class="w-4 h-4 mr-2 ${alert.type === 'info' ? 'text-blue-600' : 'text-yellow-600'}"></i>
                                <p class="text-xs text-gray-700">${alert.message}</p>
                            </div>`;
                        alertsList.innerHTML += alertElement;
                    });
                    feather.replace();
                } catch (err) {
                    console.error("Error fetching alerts:", err);
                    alertsList.innerHTML = `<p class="text-gray-500 text-sm">Error loading alerts.</p>`;
                }
            }

            async function fetchManualAttendanceRequests() {
                try {
                    const response = await fetch('/api/manual-attendance-requests');
                    const requests = await response.json();
                    manualRequestsList.innerHTML = "";
                    if (requests.length === 0) {
                        manualRequestsList.innerHTML = `<p class="text-gray-500 text-sm">No manual attendance requests.</p>`;
                        return;
                    }
                    requests.forEach(request => {
                        const requestElement = `
                            <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-md cursor-pointer" onclick="openManualAttendanceModal(${request.id}, ${request.student_id})">
                                <div>
                                    <p class="font-medium text-gray-800">${request.first_name} ${request.last_name}</p>
                                    <p class="text-xs text-gray-500">${request.enrollment_no}</p>
                                </div>
                            </div>`;
                        manualRequestsList.innerHTML += requestElement;
                    });
                } catch (err) {
                    console.error("Error fetching manual attendance requests:", err);
                    manualRequestsList.innerHTML = `<p class="text-gray-500 text-sm">Error loading requests.</p>`;
                }
            }

            window.openManualAttendanceModal = async function(requestId, studentId) {
                try {
                    const response = await fetch(`/api/student-details/${studentId}`);
                    const student = await response.json();
                    modalStudentDetails.innerHTML = `
                        <p><strong>Name:</strong> ${student.first_name} ${student.last_name}</p>
                        <p><strong>Enrollment No:</strong> ${student.enrollment_no}</p>
                        <p><strong>Current Status:</strong> ${student.status || 'Absent'}</p>
                    `;
                    modalApproveBtn.onclick = () => handleManualRequest(requestId, 'approve');
                    modalIgnoreBtn.onclick = () => handleManualRequest(requestId, 'ignore');
                    manualAttendanceModal.style.display = "block";
                } catch (err) {
                    console.error("Error fetching student details:", err);
                }
            }

            closeModal.onclick = function() {
                manualAttendanceModal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == manualAttendanceModal) {
                    manualAttendanceModal.style.display = "none";
                }
            }

            window.handleManualRequest = async function(requestId, action) {
                try {
                    const response = await fetch('/api/handle-manual-attendance-request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ request_id: requestId, action: action })
                    });
                    const data = await response.json();
                    if (data.success) {
                        manualAttendanceModal.style.display = "none";
                        fetchManualAttendanceRequests();
                        fetchStudents();
                        fetchSummary();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                } catch (err) {
                    alert(`Request failed: ${err}`);
                }
            }

            function toggleStudentView() {
                currentStatus = currentStatus === 'Present' ? 'Absent' : 'Present';
                listTitle.textContent = `${currentStatus} Students`;
                fetchStudents();
            }

            async function markManual() {
                const enrollment = enrollmentInput.value.trim();
                if (!enrollment) return;

                try {
                    const response = await fetch('/api/mark-attendance', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enrollment_no: enrollment })
                    });
                    const data = await response.json();
                    if (data.success) {
                        fetchStudents();
                        fetchSummary();
                        enrollmentInput.value = '';
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                } catch (err) {
                    alert(`Request failed: ${err}`);
                }
            }

            async function markAll(status) {
                try {
                    const response = await fetch(`/api/mark-all-${status}`, { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        currentStatus = status.charAt(0).toUpperCase() + status.slice(1);
                        fetchStudents();
                        fetchSummary();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                } catch (err) {
                    alert(`Request failed: ${err}`);
                }
            }

            toggleBtn.addEventListener("click", toggleStudentView);
            refreshBtn.addEventListener("click", () => {
                fetchStudents();
                fetchSummary();
                fetchAlerts();
                fetchManualAttendanceRequests();
            });
            markManualBtn.addEventListener("click", markManual);
            markAllPresentBtn.addEventListener("click", () => markAll('present'));
            markAllAbsentBtn.addEventListener("click", () => markAll('absent'));
            setTeacherLocationBtn.addEventListener("click", async () => {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported');
                    return;
                }
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch('/api/set-teacher-location', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ latitude: pos.coords.latitude, longitude: pos.coords.longitude })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('Location saved for geofencing checks');
                        } else {
                            alert(`Error: ${data.error || 'Failed to save location'}`);
                        }
                    } catch (e) {
                        alert('Failed to save location');
                    }
                }, (err) => {
                    alert('Location permission denied');
                });
            });

            setInterval(() => {
                fetchStudents();
                fetchSummary();
                fetchAlerts();
                fetchManualAttendanceRequests();
            }, 5000);

            fetchStudents();
            fetchSummary();
            fetchAlerts();
            fetchManualAttendanceRequests();
            feather.replace();
        });
    </script>

</body>

</html>